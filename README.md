# Video Note MVP

Минимально жизнеспособный конструктор видео-кружков из трёх частей: Telegram-бот, web-приложение и обработчик с очередью заданий.

## Структура

```
app/            # FastAPI-приложение с REST API, очередью и статикой web-приложения
bot/            # Telegram-бот на python-telegram-bot
worker/         # Фоновый обработчик, тянет задачи и рендерит результат через ffmpeg
webapp/static/  # Одностраничное WebApp-приложение
scripts/        # Скрипты запуска
tests/          # Pytest-заглушки для API-очереди
```

## Подготовка окружения

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Обязательные переменные окружения для Telegram-бота:

- `TELEGRAM_BOT_TOKEN` — токен вашего бота.
- `WEBAPP_URL` — адрес, который Telegram откроет внутри WebApp (по умолчанию `http://127.0.0.1:8000/webapp/`).
- `API_BASE_URL` — базовый URL REST API (по умолчанию `http://127.0.0.1:8000`).

Для ускорения локального рендера можно задать `WORKER_TEST_VIDEO_PATH` — путь до mp4-файла, который будет использоваться как исходник вместо обращения в Telegram. Если не задать, воркер соберёт тестовый клип с помощью `ffmpeg`.

## Локальный запуск

```bash
./scripts/run_local.sh
```

Скрипт поднимает FastAPI (`uvicorn`), запускает worker и, при наличии `TELEGRAM_BOT_TOKEN`, стартует бота. Для остановки нажмите <kbd>Ctrl</kbd> + <kbd>C</kbd> — скрипт корректно завершит дочерние процессы.

### Ручной запуск компонентов

```bash
uvicorn app.main:app --reload
python worker/worker.py
python bot/bot.py
```

Веб-интерфейс доступен по адресу `http://127.0.0.1:8000/webapp/`.

## Проверка happy-path за 5 минут

1. Активируйте виртуальное окружение, установите зависимости, запустите `./scripts/run_local.sh`.
2. В браузере откройте `http://127.0.0.1:8000/webapp/` и убедитесь, что отображается круг, тайм-линия и кнопки управления.
3. Отправьте боту видео (можно использовать `WORKER_TEST_VIDEO_PATH` для повторного прогона). Бот ответит кнопкой «Открыть редактор».
4. В WebApp задайте параметры (start/end/mute/audio only) и нажмите «Сделать кружок». Бот покажет прогресс: «Принято → В очереди N → Обработка → Готово».
5. После завершения воркер вернёт `telegram_file_id` (локальный идентификатор вида `local://...`), и бот отправит видео note (или сообщение с ID, если отправка не удалась).

## Тесты

```bash
pytest
```

Тесты покрывают базовый сценарий создания задач и обновление очереди. При необходимости можно расширить набор, добавив имитацию воркера или интеграционные проверки.
